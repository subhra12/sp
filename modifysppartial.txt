;WITH RankedStage AS (
    SELECT *,
           ROW_NUMBER() OVER (
               PARTITION BY Emp_ID, TransactionDate
               ORDER BY 
                   CASE WHEN BookedHours > 0 THEN 1 ELSE 2 END,
                   Status
           ) AS rn
    FROM #Stage
    WHERE Status <> 'Unknown'
)
SELECT *
INTO #TimeData
FROM RankedStage
WHERE 
    -- Include valid bookings
    BookedHours > 0

    -- OR include only one "Not Booked" row if no valid booking exists
    OR (Status = 'Not Booked' AND rn = 1 AND BookedHours IS NULL);
