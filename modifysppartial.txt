-- CTE for weekly status (if needed for status calculation)
WITH WeeklyStatus AS (
    SELECT
        tb.Emp_ID,
        tb.FromDate,
        tb.ToDate,
        SUM(ISNULL(bd.BookedHours, 0)) AS TotalHours,
        SUM(CASE 
            WHEN ISNULL(tb.PMApproval, 0) = 1 THEN ISNULL(bd.BookedHours, 0) 
            ELSE 0 
        END) AS ApprovedHours
    FROM dbo.TRN_TimeBooking tb
    JOIN dbo.TRN_BookedDate bd ON tb.TimeBooking_Id = bd.TimeBooking_Id
    GROUP BY tb.Emp_ID, tb.FromDate, tb.ToDate
)

SELECT
    tb.Emp_ID,
    tb.TimeBooking_Id AS [Timesheet No],

    -- Approvers' Names
    dhUser.EmployeeName AS [Approver HH Name],
    pmUser.EmployeeName AS [Approver PM Name],

    mu.EmployeeName AS [Employee Name],
    mu.UserType AS [Employee Type],
    mu.EmpDept AS [Department],
    tb.FromDate,
    tb.ToDate,
    bd.Date AS [Transaction Date],
    bd.BookedHours,
    tb.ProjectNo,
    pb.Project_Description AS [Project Description],
    tb.WBSNo,
    pb.WBS_Description,
    tb.PO,
    tb.BookedOn,
    lr.Rate AS [Labour Rate],

    -- Status
    CASE 
        WHEN tb.TimeBooking_Id IS NULL THEN 'Not Booked'
        WHEN ws.TotalHours >= 40 AND ws.ApprovedHours > 0 AND ws.ApprovedHours < ws.TotalHours THEN 'Partial Approved'
        WHEN tb.IsApproved = 1 AND tb.DHApproval = 1 AND tb.PMApproval = 1 THEN 'Approved'
        WHEN tb.DHApproval = 0 AND tb.IsSubmitted = 1 THEN 'Pending with HH'
        WHEN tb.DHApproval = 1 AND (tb.PMApproval IS NULL OR tb.PMApproval = 0) THEN 'Pending with PM'
        WHEN tb.DHApproval = 1 AND tb.PMApproval = 0 THEN 'PM rejected'
        WHEN tb.DHApproval = 0 AND tb.IsSubmitted = 1 THEN 'HH rejected'
        WHEN tb.IsSubmitted = 0 THEN 'Not Submitted'
        ELSE 'Unknown'
    END AS Status,

    -- Report Timestamp
    CAST(GETDATE() AS DATE) AS [Report Date],
    FORMAT(GETDATE(), 'hh:mm tt') AS [Report Time],

    -- Month of timecard
    FORMAT(tb.FromDate, 'MMMM yyyy') AS [Month (for which the timecard is submitted)]

FROM dbo.TRN_TimeBooking tb
LEFT JOIN dbo.TRN_BookedDate bd ON tb.TimeBooking_Id = bd.TimeBooking_Id
LEFT JOIN dbo.MST_User mu ON tb.Emp_ID = mu.EmpNo
LEFT JOIN dbo.MST_User dhUser ON tb.ApprovedByDH = dhUser.UserName
LEFT JOIN dbo.MST_User pmUser ON tb.ApprovedByPM = pmUser.UserName
LEFT JOIN dbo.ProjectBudget pb ON tb.ProjectNo = pb.Project_code AND tb.WBSNo = pb.WBS_Number
LEFT JOIN dbo.MST_LabourRate lr 
    ON lr.Department = mu.EmpDept 
    AND lr.EmployeeType = mu.UserType
    AND lr.Grade = mu.EmpGrade
    AND tb.BookedOn >= lr.FromDate 
    AND (lr.ToDate IS NULL OR tb.BookedOn <= lr.ToDate)
LEFT JOIN WeeklyStatus ws 
    ON ws.Emp_ID = tb.Emp_ID
    AND ws.FromDate = tb.FromDate
    AND ws.ToDate = tb.ToDate

WHERE mu.IsActive = 1
ORDER BY mu.EmployeeName, tb.FromDate;
