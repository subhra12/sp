;WITH WeekPeriods AS (
    SELECT DISTINCT 
        FromDate, 
        ToDate, 
        FORMAT(FromDate, 'MMMM yyyy') AS [Month]
    FROM dbo.TRN_TimeBooking
),
WeeklyStatus AS (
    SELECT
        tb.Emp_ID,
        tb.FromDate,
        tb.ToDate,
        SUM(ISNULL(bd.BookedHours, 0)) AS TotalHours,
        SUM(CASE 
                WHEN tb.DHApproval = 1 AND tb.PMApproval = 1 
                     THEN ISNULL(bd.BookedHours, 0) 
                ELSE 0 
            END) AS ApprovedHours
    FROM dbo.TRN_TimeBooking tb
    JOIN dbo.TRN_BookedDate bd 
        ON tb.TimeBooking_Id = bd.TimeBooking_Id
    WHERE tb.FromDate >= '2025-01-01' 
      AND tb.ToDate <= '2025-08-15'
    GROUP BY tb.Emp_ID, tb.FromDate, tb.ToDate
),
WeekDays AS (
    SELECT 
        wp.FromDate,
        wp.ToDate,
        d.DateValue
    FROM WeekPeriods wp
    CROSS APPLY (
        SELECT DATEADD(DAY, v.number, wp.FromDate) AS DateValue
        FROM master.dbo.spt_values v
        WHERE v.type = 'P'
          AND DATEADD(DAY, v.number, wp.FromDate) <= wp.ToDate
    ) d
)
SELECT
    mu.EmpNo AS Emp_ID,
    tb.TimeBooking_Id AS [Timesheet No],

    dhUser.EmployeeName AS [Approver HH Name],
    pmUser.EmployeeName AS [Approver PM Name],

    mu.EmployeeName AS [Employee Name],
    mu.UserType AS [Employee Type],
    mu.EmpDept AS [Department],

    wp.FromDate,
    wp.ToDate,
    wd.DateValue AS [Transaction Date],
    bd.BookedHours,
    tb.ProjectNo,
    pb.ProjectDescription AS [Project Description],
    tb.WBSNo,
    pb.WBSDescription,
    tb.PO,
    tb.BookedOn,
    lr.Rate AS [Labour Rate],

    -- Status Logic
    CASE 
        WHEN tb.TimeBooking_Id IS NULL THEN 'Not Booked'
        
        -- Fully approved week
        WHEN ws.TotalHours > 0 
             AND ws.ApprovedHours = ws.TotalHours 
        THEN 'Approved'

        -- Already approved days (part of the week)
        WHEN bd.BookedHours > 0 
             AND tb.DHApproval = 1 AND tb.PMApproval = 1 
        THEN 'Partially Approved'

        -- Remaining days submitted but not yet approved
        WHEN bd.BookedHours > 0 AND tb.IsSubmitted = 1 AND tb.DHApproval = 0 
        THEN 'Pending with HH'
        WHEN bd.BookedHours > 0 AND tb.IsSubmitted = 1 
             AND tb.DHApproval = 1 
             AND (tb.PMApproval IS NULL OR tb.PMApproval = 0)
        THEN 'Pending with PM'

        -- Rejected cases
        WHEN tb.IsRejected = 1 
             AND (tb.PMRemark <> '' AND tb.PMRemark IS NOT NULL) 
        THEN 'PM rejected'
        WHEN tb.IsRejected = 1 
             AND (tb.DHRemark <> '' AND tb.DHRemark IS NOT NULL) 
        THEN 'HH rejected'

        -- Draft
        WHEN tb.IsSubmitted = 0 THEN 'Draft'

        ELSE 'Unknown'
    END AS Status,

    -- Report Time
    CAST(GETDATE() AS DATE) AS [Report Date],
    FORMAT(GETDATE(), 'hh:mm tt') AS [Report Time],
    wp.Month AS [Month (for which the timecard is submitted)]

FROM dbo.MST_User mu
CROSS JOIN WeekPeriods wp
LEFT JOIN WeekDays wd 
    ON wp.FromDate = wd.FromDate AND wp.ToDate = wd.ToDate
LEFT JOIN dbo.TRN_TimeBooking tb 
    ON mu.EmpNo = tb.Emp_ID 
    AND tb.FromDate = wp.FromDate 
    AND tb.ToDate = wp.ToDate
LEFT JOIN dbo.TRN_BookedDate bd 
    ON tb.TimeBooking_Id = bd.TimeBooking_Id
   AND bd.Date = wd.DateValue
LEFT JOIN dbo.Budget pb 
    ON tb.ProjectNo = pb.Projectcode 
   AND tb.WBSNo = pb.WBSNumber
LEFT JOIN dbo.MST_User dhUser 
    ON tb.ApprovedByDH = dhUser.EmpNo
LEFT JOIN dbo.MST_User pmUser 
    ON tb.ApprovedByPM = pmUser.EmpNo
LEFT JOIN dbo.MST_LabourRate lr 
    ON lr.Department = mu.EmpDept 
   AND lr.EmployeeType = mu.UserType
   AND lr.Grade = mu.EmpGrade
   AND tb.BookedOn >= lr.FromDate 
   AND (lr.ToDate IS NULL OR tb.BookedOn <= lr.ToDate)
LEFT JOIN WeeklyStatus ws 
    ON ws.Emp_ID = tb.Emp_ID
   AND ws.FromDate = tb.FromDate
   AND ws.ToDate = tb.ToDate
WHERE mu.InactiveDate IS NULL
ORDER BY mu.EmployeeName, wp.FromDate, wd.DateValue;
